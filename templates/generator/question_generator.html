<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Questões Cespe (C/E) - Gemini/Gemma</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .container { max-width: 900px; }
        .question-item { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; background-color: #fff; }
        .question-item p { margin-bottom: 0.75rem; } /* Ajuste de margem */
        .form-check-inline { margin-right: 1rem; } /* Espaçamento entre C/E */
        .spinner-border { display: none; /* Escondido inicialmente */ }
        button:disabled { cursor: not-allowed; }
        small.form-text { color: #6c757d; }
        .form-container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 2rem;
        }
         h1, h2 { color: #343a40; }
         .alert { margin-top: 1rem; }
         /* Estilos para resultados */
         .correct-answer { color: green; font-weight: bold; }
         .incorrect-answer { color: red; font-weight: bold; }
         .feedback { font-style: italic; font-size: 0.9em; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-4">
            <h1>Gerador de Questões Estilo Cebraspe (Certo/Errado)</h1>
            <p class="lead">Use a IA Gemini/Gemma para criar itens de julgamento sobre um tópico.</p>
            <p><small>Executando em: Boa Vista/RR (Horário Local {{ local_time }})</small></p> {# Exemplo: Adicionar hora local na view se desejar #}
        </header>

        {% if not service_initialized %}
            <div class="alert alert-danger" role="alert">
                <strong>Erro Crítico de Configuração:</strong> O serviço de geração de questões não pôde ser inicializado. O formulário está desabilitado. Por favor, contate o administrador. <br>
                 {% if error_message %} Detalhe técnico: {{ error_message }} {% endif %}
            </div>
        {% endif %}

        {# Formulário para GERAR as questões #}
        <div class="form-container">
            {# !! Assume que a URL para gerar questões se chama 'generate_questions' no urls.py !! #}
            <form method="post" id="generator-form" action="{% url 'generate_questions' %}" {% if not service_initialized %} style="opacity: 0.6; pointer-events: none;" {% endif %}>
                {% csrf_token %}

                <div class="mb-3">
                    <label for="{{ form.topic.id_for_label }}" class="form-label">{{ form.topic.label }}</label>
                    {{ form.topic }} {# Renderiza o widget Textarea #}
                    {% if form.topic.help_text %}<small class="form-text text-muted">{{ form.topic.help_text }}</small>{% endif %}
                    {% if form.topic.errors %}<div class="invalid-feedback d-block">{{ form.topic.errors|striptags }}</div>{% endif %}
                </div>

                <div class="mb-3">
                    <label for="{{ form.num_questions.id_for_label }}" class="form-label">{{ form.num_questions.label }}</label>
                    {{ form.num_questions }} {# Renderiza o widget NumberInput #}
                     {% if form.num_questions.help_text %}<small class="form-text text-muted">{{ form.num_questions.help_text }}</small>{% endif %}
                     {% if form.num_questions.errors %}<div class="invalid-feedback d-block">{{ form.num_questions.errors|striptags }}</div>{% endif %}
                </div>

                {# Botão para gerar questões (action="generate") #}
                <button type="submit" name="action" value="generate" class="btn btn-primary" id="submit-button" {% if not service_initialized %} disabled {% endif %}>
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" id="loading-spinner"></span>
                    <span id="button-text">Gerar Questões</span>
                </button>
            </form>
        </div>

        {% if error_message and service_initialized %} {# Só mostra erro geral se não for o de inicialização #}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <strong>Atenção:</strong> {{ error_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}

        {# Formulário e Exibição das Questões Geradas #}
        {% if questions %}
            <div class="results-container mt-4">
                <h2>Itens Gerados para Julgamento:</h2>

                {# Novo formulário para ENVIAR as respostas do usuário #}
                 {# !! Assume que a URL para validar se chama 'validate_answers' no urls.py !! #}
                <form method="post" action="{% url 'validate_answers' %}">
                    {% csrf_token %}

                    {% for item in questions %}
                        <div class="question-item">
                            <p><strong>Item {{ forloop.counter }}:</strong></p>
                            {# Exibe a afirmação gerada pela IA #}
                            <p>{{ item.afirmacao|linebreaksbr }}</p>

                            {# Adiciona os botões de rádio Certo/Errado #}
                            <div class="mb-2">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="resposta_{{ forloop.counter0 }}" id="certo_{{ forloop.counter0 }}" value="C" required>
                                    <label class="form-check-label" for="certo_{{ forloop.counter0 }}">Certo</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="resposta_{{ forloop.counter0 }}" id="errado_{{ forloop.counter0 }}" value="E" required>
                                    <label class="form-check-label" for="errado_{{ forloop.counter0 }}">Errado</label>
                                </div>
                            </div>
                             {# Campos ocultos para facilitar a validação na view #}
                             <input type="hidden" name="index_{{ forloop.counter0 }}" value="{{ forloop.counter0 }}">
                             <input type="hidden" name="afirmacao_{{ forloop.counter0 }}" value="{{ item.afirmacao }}">
                             <input type="hidden" name="gabarito_{{ forloop.counter0 }}" value="{{ item.gabarito }}">
                        </div>
                        {% if not forloop.last %}<hr>{% endif %}
                    {% empty %}
                         <div class="alert alert-info" role="alert">
                           Nenhuma questão foi retornada ou processada. Tente gerar novamente.
                         </div>
                    {% endfor %}

                    {# Adiciona o botão de submit SÓ SE houver questões #}
                    {% if questions %}
                       {# Botão para verificar respostas (action="validate") #}
                       <button type="submit" name="action" value="validate" class="btn btn-success mt-3">Verificar Respostas</button>
                    {% endif %}
                </form> {# Fim do formulário de respostas #}

            </div> {# Fim do results-container #}
        {% endif %}


         {# --- SEÇÃO DE RESULTADOS CORRIGIDA --- #}
         {# Área para exibir resultados da validação (será preenchida pela view depois) #}
         {% if results %}
             <div class="results-validation mt-4">
                 <h2>Resultado da Verificação:</h2>
                 {% for result in results %}
                     {# Adiciona classe de borda verde/vermelha baseado no acerto #}
                     <div class="question-item {% if result.correct %}border-success{% else %}border-danger{% endif %}">
                         <p><strong>Item {{ forloop.counter }}:</strong></p>
                         <p>{{ result.afirmacao|linebreaksbr }}</p> {# Afirmação original #}
                         <p>Sua Resposta:
                             {# Adiciona classe de cor na resposta do usuário #}
                             <span class="{% if result.correct %}correct-answer{% else %}incorrect-answer{% endif %}">
                                 {# Usa if para exibir Certo/Errado baseado no valor 'C'/'E' #}
                                 {% if result.user_answer == 'C' %}
                                     Certo
                                 {% elif result.user_answer == 'E' %}
                                     Errado
                                 {% else %}
                                     {{ result.user_answer|default:"Não respondido" }} {# Se não for C/E #}
                                 {% endif %}
                             </span>
                         </p>
                         <p class="feedback">
                             {% if result.correct %}
                                 <span class="correct-answer">Você acertou!</span>
                             {% else %}
                                 <span class="incorrect-answer">Você errou.</span>
                             {% endif %}
                             {# Exibe o gabarito usando if #}
                             Gabarito: {% if result.gabarito == 'C' %}Certo{% elif result.gabarito == 'E' %}Errado{% else %}{{ result.gabarito }}{% endif %}
                         </p>
                     </div>
                 {% endfor %}
                 {# Aqui você poderia adicionar um placar total, se desejar #}
                 {# Ex: <p><strong>Placar: X acertos de Y questões.</strong></p> #}
             </div>
         {% endif %}
         {# --- FIM DA SEÇÃO DE RESULTADOS CORRIGIDA --- #}


    </div> {# Fim do .container #}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    {# Script de loading (pode ser mantido ou melhorado depois) #}
    <script>
        const form = document.getElementById('generator-form');
        const submitButton = document.getElementById('submit-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const buttonText = document.getElementById('button-text');
        const serviceInitialized = {{ service_initialized|yesno:"true,false" }};

         if (!serviceInitialized && submitButton) {
             submitButton.disabled = true;
        }

        if (form && submitButton && loadingSpinner && buttonText) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity()) {
                    // Verifica se o botão clicado foi o de gerar (se houver outros submits)
                    const action = event.submitter ? event.submitter.value : 'generate';
                    if (action === 'generate') {
                         submitButton.disabled = true;
                         loadingSpinner.style.display = 'inline-block';
                         buttonText.textContent = ' Gerando...';
                    }
                } else {
                     console.log("Validação HTML5 do formulário de geração falhou.");
                }
            });
        }

        window.addEventListener('pageshow', function (event) {
            if (event.persisted && submitButton && serviceInitialized) {
                 submitButton.disabled = false;
                 loadingSpinner.style.display = 'none';
                 buttonText.textContent = 'Gerar Questões';
            }
        });
    </script>

</body>
</html>