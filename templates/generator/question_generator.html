{% extends 'generator/base.html' %}
{% load static %}
{# {% load humanize %} - Se necessário para outras partes #}

{% block title %}Gerador de Questões C/E - Gerador IA{% endblock title %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'generator/css/question_generator_styles.css' %}">
    <style>
        /* Seus estilos CSS aqui... */
        .nav-tabs .nav-link { border-top-left-radius: 0.375rem; border-top-right-radius: 0.375rem; border-bottom: none; color: var(--bs-secondary-color); background-color: var(--bs-tertiary-bg); border-color: var(--bs-border-color); padding: 0.5rem 1rem; }
        .nav-tabs .nav-link.active { color: var(--bs-primary); background-color: var(--bs-body-bg); border-color: var(--bs-border-color); border-bottom-color: var(--bs-body-bg); font-weight: 600; }
        .filters-container { border: 1px solid var(--bs-border-color); border-top: none; padding: 1.5rem; border-bottom-left-radius: 0.375rem; border-bottom-right-radius: 0.375rem; background-color: var(--bs-body-bg); }
        .form-label { font-size: 0.85rem; margin-bottom: 0.3rem; }
        .form-control, .form-select { font-size: 0.9rem; }
        .form-control-sm, .form-select-sm { font-size: 0.85rem; }
        .form-text { font-size: 0.75rem; }
        /* Removida a classe .btn-filter-action se não for mais usada ou definida aqui */
        .ce-result-feedback { min-height: 1.5em; padding-top: 0.5rem; border-top: 1px solid var(--bs-border-color-translucent); margin-top: 0.75rem; }
        .ce-result-feedback:empty { display: none; }
        .verify-ce-btn { font-size: 0.8rem; }
        .motivador-text { background-color: var(--bs-secondary-bg); border-left: 5px solid var(--bs-info); padding: 1rem; margin-bottom: 1.5rem; font-size: 0.95em; border-radius: 0.375rem; white-space: pre-wrap; }
        .question-item-minimal { padding: 1rem; border: 1px solid var(--bs-border-color); border-radius: 0.375rem; margin-bottom: 1rem; }
        .results-validation .question-item-minimal { border-width: 1px; border-style: solid; border-radius: 0.375rem; }
        #addAreaQuickFormContainer { margin-top: 0.5rem; }
        #addAreaQuickFormGenerator .input-group-text, #addAreaQuickFormGenerator .form-control-sm, #addAreaQuickFormGenerator .btn-sm { font-size: 0.8rem; }
        #id_topic { min-height: 80px; } /* Usando ID padrão */
        .pagination { margin-bottom: 1rem; }
         /* Garante que botões dentro do btn-group não tenham margens extras indesejadas */
        .btn-group .btn { margin: 0 !important; }

    </style>
{% endblock extra_head %}

{% block content %}

    {# Mensagens #}
    {% if error_message %} <div class="alert alert-danger alert-dismissible fade show"><strong>Erro:</strong> {{ error_message }} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div> {% endif %}
    {% if not service_initialized and not error_message %} <div class="alert alert-warning alert-dismissible fade show"><strong>Atenção:</strong> Serviço de IA indisponível ou com erro na inicialização. <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div> {% endif %}
    {% if messages %}{% for message in messages %}<div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} alert-dismissible fade show"> {{ message }} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>{% endfor %}{% endif %}

    {# --- Abas de Navegação --- #}
    <ul class="nav nav-tabs mb-0" id="mainTabs" role="tablist">
       <li class="nav-item" role="presentation"> <a class="nav-link active" href="{% url 'generator:generate_questions' %}" id="objetivas-tab" role="tab" aria-selected="true">Gerador C/E</a> </li>
       <li class="nav-item" role="presentation"> <a class="nav-link" href="{% url 'generator:generate_discursive_exam' %}">Gerador Discursiva</a> </li>
       <li class="nav-item" role="presentation"> <a class="nav-link" href="{% url 'generator:configurar_simulado' %}">Configurar Simulado</a> </li>
       <li class="nav-item" role="presentation"> <a class="nav-link" href="{% url 'generator:dashboard' %}">Meu Desempenho</a> </li>
       {# <li class="nav-item" role="presentation"> <a class="nav-link" href="{% url 'generator:questions_ce' %}">Banco de Questões</a> </li> #}
    </ul>
    {# --- Fim Abas de Navegação --- #}

    {# Container dos Filtros (Formulário de Geração) #}
    <div class="tab-content" id="questionTypeTabContent">
      <div class="tab-pane fade show active" id="objetivas-panel" role="tabpanel" aria-labelledby="objetivas-tab">
        <div class="filters-container shadow-sm">
            {# Formulário principal #}
            <form method="post" id="generator-form" action="{% url 'generator:generate_questions' %}" {% if not service_initialized %} style="opacity: 0.6; pointer-events: none;" {% endif %}>
                {% csrf_token %}
                <div class="row g-3">
                    {# Coluna Esquerda: Tópico/Contexto #}
                    <div class="col-lg-6">
                        <label for="{{ form.topic.id_for_label|default:'id_topic' }}" class="form-label fw-medium">{{ form.topic.label|default:"Tópico ou Contexto" }}</label>
                        {{ form.topic }}
                        {% if form.topic.help_text %}<div class="form-text text-muted mt-1">{{ form.topic.help_text|safe }}</div>{% endif %}
                        {% if form.topic.errors %}<div class="invalid-feedback d-block">{{ form.topic.errors|striptags }}</div>{% endif %}
                    </div>

                    {# Coluna Direita: Campos + Botões #}
                    <div class="col-lg-6">
                        {# Linha interna para os campos #}
                        <div class="row g-3">
                             {# --- CAMPO Nº QUESTÕES --- #}
                             <div class="col-md-4">
                                 <label for="{{ form.num_questions.id_for_label|default:'id_num_questions' }}" class="form-label fw-medium">{{ form.num_questions.label|default:"Nº Questões" }}</label>
                                 {{ form.num_questions }}
                                 {% if form.num_questions.errors %}<div class="invalid-feedback d-block">{{ form.num_questions.errors|striptags }}</div>{% endif %}
                             </div>
                             {# --- FIM Nº QUESTÕES --- #}

                             {# --- CAMPO DIFICULDADE --- #}
                             <div class="col-md-4">
                                 <label for="{{ form.difficulty_level.id_for_label|default:'id_difficulty_level' }}" class="form-label fw-medium">{{ form.difficulty_level.label|default:"Dificuldade" }}</label>
                                 {{ form.difficulty_level }}
                                 {% if form.difficulty_level.errors %}<div class="invalid-feedback d-block">{{ form.difficulty_level.errors|striptags }}</div>{% endif %}
                             </div>
                             {# --- FIM DIFICULDADE --- #}

                             {# --- CAMPO ÁREA --- #}
                             <div class="col-md-4">
                                 <label for="{{ form.area.id_for_label|default:'id_area' }}" class="form-label fw-medium">{{ form.area.label|default:"Área" }}</label>
                                 {{ form.area }}
                                 {% if form.area.errors %}<div class="invalid-feedback d-block">{{ form.area.errors|striptags }}</div>{% endif %}
                             </div>
                             {# --- FIM ÁREA --- #}
                        </div> {# +++++ BOTÕES DE AÇÃO (USANDO BTN-GROUP) +++++ #}
                        <div class="btn-group w-100 mt-4" role="group" aria-label="Grupo de Ações do Gerador">
                            <button type="reset" form="generator-form" class="btn btn-outline-secondary btn-sm" title="Limpa os campos do formulário"> <i class="bi bi-x-lg"></i> Limpar Formulário </button>
                            <a href="{% url 'generator:generate_questions' %}?action=clear" class="btn btn-outline-warning btn-sm" role="button" title="Remove o último lote gerado da tela"> <i class="bi bi-eraser"></i> Limpar Resultado </a>
                            <a href="{% url 'generator:questions_ce' %}" id="search-db-button" class="btn btn-outline-success btn-sm" role="button" title="Busca questões existentes usando Tópico/Área"> <i class="bi bi-search"></i> Buscar no Banco </a>
                            <button type="submit" form="generator-form" class="btn btn-primary btn-sm" id="submit-button" {% if not service_initialized %} disabled {% endif %} title="Gera novas questões"> <span id="button-content-wrapper"> <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="loading-spinner"></span> <span id="button-text"><i class="bi bi-robot"></i> Gerar Questões por IA</span> </span> </button>
                        </div>
                        {# +++++ FIM BOTÕES COM BTN-GROUP +++++ #}

                    </div>{# Fim col-lg-6 #}
                </div>{# Fim row g-3 principal #}
            </form>

            {# Formulário Rápido de Área #}
            <div id="addAreaQuickFormContainer" class="mt-2"> <form id="addAreaQuickFormGenerator" method="post" action="{% url 'generator:add_area_quick_from_generator' %}" > {% csrf_token %} <div class="input-group input-group-sm"> <input type="text" class="form-control form-control-sm" name="nome" placeholder="Não encontrou a área? Adicione-a." required maxlength="100" aria-label="Nome da nova área"> <button type="submit" class="btn btn-outline-primary btn-sm"> <i class="bi bi-plus-lg"></i> Add </button> </div> </form> </div>
        </div>
      </div>
      {# Outras abas #}
    </div>

    {# Rodapé #}
    <div class="alert alert-secondary mt-4 small text-center"> Use os filtros acima para gerar novas questões C/E ou clique em Buscar no Banco. </div>

    {# === SEÇÃO DE RESULTADOS (MOTIVADOR + LISTA PAGINADA) === #}
    {% if main_motivador %} <hr class="my-4"> <div class="motivador-text"> <h2 class="h6 text-muted mb-2 fw-normal"><i class="bi bi-info-circle me-1"></i>Texto Motivador</h2> <div class="small">{{ main_motivador|linebreaksbr }}</div> </div> {% endif %}
    {% if page_obj %}
        {% if not main_motivador %}<hr class="my-4">{% endif %}
        <div class="mt-4">
             <h2 class="h5 mb-3 fw-normal">Itens Gerados (Página {{ page_obj.number }} de {{ paginator.num_pages }}):</h2>
             <form id="validate-form" data-validate-single-url="{% url 'generator:validate_single_ce' %}">
                {% csrf_token %}
                <div class="question-list">
                    {% for item in page_obj %} <div class="question-item-minimal" id="question-item-{{ item.id }}"> <p class="mb-2"><strong>Item {{ page_obj.start_index|add:forloop.counter0 }}:</strong></p> <p class="ms-3">{{ item.texto_comando|linebreaksbr }}</p> <div class="d-flex align-items-center flex-wrap mt-3"> <div class="form-check form-check-inline me-3"> <input class="form-check-input question-radio" type="radio" name="resposta_q{{ item.id }}" id="certo_{{ item.id }}" value="C" required> <label class="form-check-label small" for="certo_{{ item.id }}">Certo</label> </div> <div class="form-check form-check-inline me-3"> <input class="form-check-input question-radio" type="radio" name="resposta_q{{ item.id }}" id="errado_{{ item.id }}" value="E" required> <label class="form-check-label small" for="errado_{{ item.id }}">Errado</label> </div> <button type="button" class="btn btn-outline-info btn-sm ms-md-auto mt-2 mt-md-0 verify-ce-btn" data-questao-id="{{ item.id }}"> <i class="bi bi-check-lg"></i> Verificar Item </button> </div> <div class="ce-result-feedback mt-2 small" id="result-feedback-{{ item.id }}"></div> </div> {% empty %} <div class="alert alert-info" role="alert">Nenhuma questão neste lote/página.</div> {% endfor %}
                </div>
                {# Controles de Paginação #}
                {% if paginator.num_pages > 1 %} <nav aria-label="Navegação dos itens gerados" class="mt-4 d-flex justify-content-center"> <ul class="pagination flex-wrap"> {% if page_obj.number > 1 %}<li class="page-item"><a class="page-link" href="?page=1" aria-label="Primeira">&laquo;&laquo;</a></li>{% else %}<li class="page-item disabled"><span class="page-link">&laquo;&laquo;</span></li>{% endif %} {% if page_obj.has_previous %}<li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Anterior">&laquo;</a></li>{% else %}<li class="page-item disabled"><span class="page-link">&laquo;</span></li>{% endif %} {% for num in paginator.page_range %}{% if page_obj.number == num %}<li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>{% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}<li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>{% elif num == 1 %}<li class="page-item d-none d-sm-block"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>{% if page_obj.number > 3 %}<li class="page-item disabled d-none d-sm-block"><span class="page-link">...</span></li>{% endif %}{% elif num == paginator.num_pages %}{% if page_obj.number < paginator.num_pages|add:'-2' %}<li class="page-item disabled d-none d-sm-block"><span class="page-link">...</span></li>{% endif %}<li class="page-item d-none d-sm-block"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>{% endif %}{% endfor %} {% if page_obj.has_next %}<li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Próximo">&raquo;</a></li>{% else %}<li class="page-item disabled"><span class="page-link">&raquo;</span></li>{% endif %} {% if page_obj.number < paginator.num_pages %}<li class="page-item"><a class="page-link" href="?page={{ paginator.num_pages }}" aria-label="Última">&raquo;&raquo;</a></li>{% else %}<li class="page-item disabled"><span class="page-link">&raquo;&raquo;</span></li>{% endif %} </ul> </nav> {% endif %}
             </form>
         </div>
    {% endif %} {# Fim if page_obj #}

     {# Seção de Resultados da VALIDAÇÃO GERAL (mantida) #}
     {% if results %} <hr class="my-4"> <div class="results-validation mt-4"> <h2 class="h5 mb-3 fw-normal">Resultado da Verificação Geral:</h2> {# ... (código results/performance) ... #} </div> {% endif %}

{% endblock content %}


{% block extra_js %}
    <script src="{% static 'generator/js/question_generator_scripts.js' %}" defer></script>
    <script src="{% static 'generator/js/ce_validator.js' %}" defer></script>

    {# +++++ SCRIPT PARA BOTÃO BUSCAR NO BANCO COM FILTROS +++++ #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchButton = document.getElementById('search-db-button');
            const topicInput = document.getElementById('id_topic'); // << VERIFIQUE ESTE ID no HTML renderizado
            const areaSelect = document.getElementById('id_area'); // << VERIFIQUE ESTE ID no HTML renderizado

            if (searchButton && topicInput && areaSelect) {
                searchButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    const topicValue = topicInput.value.trim();
                    const areaValue = areaSelect.value;
                    const baseUrl = searchButton.href;
                    const params = new URLSearchParams();
                    if (topicValue) { params.append('q', topicValue); }
                    if (areaValue) { params.append('area', areaValue); }
                    let finalUrl = baseUrl;
                    const queryString = params.toString();
                    if (queryString) { finalUrl += '?' + queryString; }
                    console.log('Redirecionando para busca com filtros:', finalUrl);
                    window.location.href = finalUrl;
                });
            } else {
                console.error('Elementos não encontrados para busca: #search-db-button, #id_topic, #id_area.');
            }
        });
    </script>
    {# +++++ FIM SCRIPT +++++ #}

{% endblock extra_js %}