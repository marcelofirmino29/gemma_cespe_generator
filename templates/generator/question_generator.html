{% extends 'generator/base.html' %} {# <<< PASSO 1: Herda do base.html #}
{% load static %}

{% block title %}Gerador C/E - Gerador IA{% endblock title %} {# <<< Opcional: Título específico #}

{% block extra_head %} {# <<< Bloco para CSS específico desta página #}
    <style>
        /* Estilos específicos para a página C/E */
        .question-item {
             background-color: var(--bs-body-bg); border: 1px solid var(--bs-border-color);
             padding: 15px; margin-bottom: 15px; border-radius: 5px;
        }
        .question-item p { margin-bottom: 0.75rem; }
        .form-check-inline { margin-right: 1rem; }
        .spinner-border { display: none; }
        button:disabled { cursor: not-allowed; }
        small.form-text { color: var(--bs-secondary-color); }
        .form-container {
            background-color: var(--bs-tertiary-bg); padding: 2rem; border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); margin-bottom: 2rem;
        }
         .alert { margin-top: 1rem; }
         /* Estilos para resultados */
         .correct-answer { color: var(--bs-success-text-emphasis); font-weight: bold; } /* Usando variável BS direta */
         .incorrect-answer { color: var(--bs-danger-text-emphasis); font-weight: bold; } /* Usando variável BS direta */
         .feedback { font-style: italic; font-size: 0.9em; margin-top: 5px; }
         .justification { margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--bs-border-color-translucent); } /* Ajuste visual */

         /* Estilos para o resumo de performance */
         .results-validation { margin-top: 2rem; } /* Espaçamento */
         .performance-summary {
             border: 1px solid var(--bs-border-color);
             background-color: var(--bs-secondary-bg);
             border-radius: .375rem; /* Consistente com outros elementos */
         }
         .performance-summary h4 { color: var(--bs-emphasis-color); }
         .performance-summary .table { margin-bottom: 0.5rem !important; }
         .performance-summary .alert { font-size: 0.95em; }

         /* Ajustes Dark Mode (Herda a maioria do base, mas pode ter específicos) */
         [data-bs-theme="dark"] .form-container,
         [data-bs-theme="dark"] .results-container, /* Adicionado para consistência */
         [data-bs-theme="dark"] .answer-input-section { box-shadow: 0 0.125rem 0.25rem rgba(255, 255, 255, 0.075); }
    </style>
{% endblock extra_head %}


{% block content %} {# <<< PASSO 2: Todo o conteúdo específico da página vai aqui #}

    {# Removido o Seletor de Tema e SVGs מכאן, pois eles estão no base.html #}

    {# Header específico da página C/E #}
     <header class="text-center mb-4">
        <h1>Gerador de Questões Estilo Cebraspe (Certo/Errado)</h1>
        <p class="lead">Use a IA Gemini/Gemma para criar itens de julgamento sobre um tópico.</p>
        {% if local_time %}<p><small>(Horário Local {{ local_time }})</small></p>{% endif %}
        <!-- {# Navegação Breadcrumb (Pode simplificar/remover se o header base for suficiente) #}
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb justify-content-center">
            <li class="breadcrumb-item"><a href="{% url 'landing_page' %}">Início</a></li>
            <li class="breadcrumb-item active" aria-current="page">Gerador C/E</li>
          </ol>
        </nav> -->
    </header>

    {# Mensagem de erro de inicialização #}
    {% if not service_initialized %}
        <div class="alert alert-danger" role="alert">
            <strong>Erro Crítico de Configuração:</strong> O serviço de geração não pôde ser inicializado. O formulário está desabilitado. <br>
             {% if error_message %} Detalhe técnico: {{ error_message }} {% endif %}
        </div>
    {% endif %}

    {# Formulário de Geração C/E #}
    <div class="form-container">
        <form method="post" id="generator-form" action="{% url 'generate_questions' %}" {% if not service_initialized %} style="opacity: 0.6; pointer-events: none;" {% endif %}>
            {% csrf_token %}
             <div class="mb-3">
                <label for="{{ form.topic.id_for_label }}" class="form-label">{{ form.topic.label }}</label>
                {{ form.topic }} {# Renderiza widget do form #}
                {% if form.topic.help_text %}<small class="form-text text-muted">{{ form.topic.help_text }}</small>{% endif %}
                {% if form.topic.errors %}<div class="invalid-feedback d-block">{{ form.topic.errors|striptags }}</div>{% endif %}
            </div>
             <div class="row mb-3">
                <div class="col-md-4">
                    <label for="{{ form.num_questions.id_for_label }}" class="form-label">{{ form.num_questions.label }}</label>
                    {{ form.num_questions }} {# Renderiza widget #}
                     {% if form.num_questions.help_text %}<small class="form-text text-muted">{{ form.num_questions.help_text }}</small>{% endif %}
                     {% if form.num_questions.errors %}<div class="invalid-feedback d-block">{{ form.num_questions.errors|striptags }}</div>{% endif %}
                </div>
                 <div class="col-md-8"> {# Ajustado col-md para ocupar espaço restante #}
                    <label for="{{ form.difficulty_level.id_for_label }}" class="form-label">{{ form.difficulty_level.label }}</label>
                    {{ form.difficulty_level }} {# Renderiza widget #}
                    {% if form.difficulty_level.help_text %}<small class="form-text text-muted">{{ form.difficulty_level.help_text }}</small>{% endif %}
                    {% if form.difficulty_level.errors %}<div class="invalid-feedback d-block">{{ form.difficulty_level.errors|striptags }}</div>{% endif %}
                </div>
            </div>
             <button type="submit" class="btn btn-primary" id="submit-button" {% if not service_initialized %} disabled {% endif %}>
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" id="loading-spinner"></span>
                <span id="button-text">Gerar Questões</span>
            </button>
        </form>
    </div>

    {# Mensagem de erro geral da Geração #}
    {% if error_message and service_initialized and not form.errors %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>Atenção ao Gerar:</strong> {{ error_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}

    {# Bloco para exibir questões geradas e formulário de respostas #}
    {% if questions %}
        <div class="results-container mt-4">
             <h2 class="h4 mb-3">Itens Gerados para Julgamento:</h2>
             <form method="post" action="{% url 'validate_answers' %}">
                {% csrf_token %}
                {% for item in questions %}
                    <div class="question-item">
                        <p><strong>Item {{ forloop.counter }}:</strong> {{ item.afirmacao|linebreaksbr }}</p>
                         <div class="mb-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="resposta_{{ forloop.counter0 }}" id="certo_{{ forloop.counter0 }}" value="C" required>
                                <label class="form-check-label" for="certo_{{ forloop.counter0 }}">Certo</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="resposta_{{ forloop.counter0 }}" id="errado_{{ forloop.counter0 }}" value="E" required>
                                <label class="form-check-label" for="errado_{{ forloop.counter0 }}">Errado</label>
                            </div>
                        </div>
                         {# Campos ocultos para enviar dados para validação #}
                         <input type="hidden" name="index_{{ forloop.counter0 }}" value="{{ forloop.counter0 }}">
                         <input type="hidden" name="afirmacao_{{ forloop.counter0 }}" value="{{ item.afirmacao }}">
                         <input type="hidden" name="gabarito_{{ forloop.counter0 }}" value="{{ item.gabarito|default:'?' }}">
                         <input type="hidden" name="justificativa_{{ forloop.counter0 }}" value="{{ item.justificativa|default:'Justificativa não fornecida.' }}">
                    </div>
                    {% if not forloop.last %}<hr class="my-3 d-md-none">{% endif %} {# Linha divisória apenas em telas pequenas? Ou sempre? Ajuste. #}
                {% empty %}
                     <div class="alert alert-info" role="alert">Nenhuma questão foi retornada.</div>
                {% endfor %}
                 {% if questions %}
                   <button type="submit" class="btn btn-success mt-3">Verificar Respostas</button>
                {% endif %}
            </form>
         </div>
    {% endif %}

     {# --- SEÇÃO DE RESULTADOS DA VALIDAÇÃO --- #}
     {% if results %}
         <div class="results-validation mt-4">
             <h2 class="h4 mb-3">Resultado da Verificação:</h2>
             {% if error_message %} {# Mostra erro de processamento da validação, se houver #}
                 <div class="alert alert-danger"><strong>Erro ao Processar Validação:</strong> {{ error_message }}</div>
             {% endif %}

             {% for result in results %}
                 <div class="question-item {% if result.correct %}border-success{% else %}border-danger{% endif %}">
                     <p><strong>Item {{ forloop.counter }}:</strong> {{ result.afirmacao|linebreaksbr }}</p>
                     <p>Sua Resposta: <span class="{% if result.correct %}correct-answer{% else %}incorrect-answer{% endif %}">{% if result.user_answer == 'C' %}Certo{% elif result.user_answer == 'E' %}Errado{% else %}{{ result.user_answer|default:"Não resp." }}{% endif %}</span>
                        (<span class="small">Gabarito: {% if result.gabarito == 'C' %}Certo{% elif result.gabarito == 'E' %}Errado{% else %}?{% endif %}</span>)
                     </p>
                     <p class="feedback mb-0"> {# Removido margin bottom #}
                         {% if result.correct %}
                            <span class="correct-answer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill me-1" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.354 10.354l-2-2a.5.5 0 0 0-.708.708L7.293 11.5l3.5-3.5a.5.5 0 0 0-.708-.708l-3 3z"/></svg>Você acertou!</span>
                         {% else %}
                            <span class="incorrect-answer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle-fill me-1" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/></svg>Você errou.</span>
                         {% endif %}
                     </p>
                      {% if result.justificativa and result.justificativa != 'Justificativa não fornecida.' and result.justificativa != 'N/A.' %}
                     <div class="justification mt-2 pt-2 border-top">
                         <p class="text-muted small mb-0">{{ result.justificativa|linebreaksbr }}</p>
                     </div>
                     {% endif %}
                 </div>
             {% endfor %}

             {# Resumo de Performance #}
             {% if performance %}
             <div class="performance-summary mt-4 p-3 rounded">
                 <h4 class="mb-3">Resumo do Desempenho (Estilo Cebraspe)</h4>
                 <table class="table table-sm table-borderless mb-2" style="max-width: 350px;">
                     <tbody>
                         <tr><td>Itens Respondidos:</td><td class="text-end fw-bold">{{ performance.total }}</td></tr>
                         <tr><td>Acertos:</td><td class="text-end"><strong class="correct-answer">{{ performance.correct }}</strong>&nbsp;(+{{ performance.correct }})</td></tr>
                         <tr><td>Erros:</td><td class="text-end"><strong class="incorrect-answer">{{ performance.incorrect }}</strong>&nbsp;(-{{ performance.incorrect }})</td></tr>
                         <tr><td class="border-top pt-2"><strong>Pontuação Líquida:</strong></td><td class="text-end border-top pt-2"><strong style="font-size: 1.1em;">{% if performance.score > 0 %}+{% endif %}{{ performance.score }}</strong> / {{ performance.total }}</td></tr>
                          <tr><td>Aproveitamento Bruto:</td><td class="text-end fw-bold">{{ performance.percentage }}%</td></tr>
                     </tbody>
                 </table>
                  {% if performance.total > 0 %}
                      {% if performance.score == performance.total %}<p class="alert alert-success py-2 mb-0">Excelente! Gabaritou!</p>
                      {% elif performance.more_than_half %}<p class="alert alert-info py-2 mb-0">Ótimo! Pontuação bem positiva.</p>
                      {% elif performance.score > 0 %}<p class="alert alert-secondary py-2 mb-0">Bom! Pontuação positiva.</p>
                      {% elif performance.score == 0 %}<p class="alert alert-warning py-2 mb-0">Neutro. Pontuação líquida zero.</p>
                      {% else %}<p class="alert alert-danger py-2 mb-0">Atenção! Pontuação negativa.</p>{% endif %}
                 {% endif %}
             </div>
             {% endif %} {# Fim if performance #}

         </div>
     {% endif %}
     {# --- FIM DA SEÇÃO DE RESULTADOS --- #}

{% endblock content %} {# <<< Fim do Bloco de Conteúdo Específico #}


{% block extra_js %} {# <<< Bloco para JS específico desta página #}
    {# Script de loading (mantido) #}
    <script>
        const form = document.getElementById('generator-form');
        const submitButton = document.getElementById('submit-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const buttonText = document.getElementById('button-text');
        // A variável JS 'serviceInitialized' deve ser definida pelo Django template
        const serviceInitialized = {{ service_initialized|yesno:"true,false" }};

         if (!serviceInitialized && submitButton) {
             submitButton.disabled = true;
        }

        if (form && submitButton && loadingSpinner && buttonText) {
            form.addEventListener('submit', function(event) {
                // if (!form.checkValidity()) { // Validação HTML5 básica
                //      console.log("Form C/E inválido (HTML5).");
                //      event.preventDefault();
                //      return;
                // }
                 // Mostra loading após validação passar (ou se não checou)
                 submitButton.disabled = true;
                 loadingSpinner.style.display = 'inline-block';
                 buttonText.textContent = ' Gerando...';
            });
        }
         // Reseta botão ao voltar com histórico
        window.addEventListener('pageshow', function (event) {
            if (event.persisted && submitButton && serviceInitialized) {
                 submitButton.disabled = false;
                 loadingSpinner.style.display = 'none';
                 buttonText.textContent = 'Gerar Questões';
            }
        });
    </script>
    {# O Script do Dark Mode NÃO deve estar aqui, mas sim no base.html #}
{% endblock extra_js %}