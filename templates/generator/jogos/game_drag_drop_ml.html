{% extends 'generator/base.html' %}
{% load static %}

{% block title %}Jogo: Categorias de Algoritmos de ML{% endblock title %}

{% block extra_head %}
    {# CSS específico para o jogo #}
    <style>
        /* Estilo para os itens arrastáveis (tags) */
        .draggable-tag {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            margin: 0.25rem;
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid var(--bs-border-color-translucent); /* Usa variável Bootstrap */
            background-color: var(--bs-tertiary-bg); /* Fundo sutil */
            color: var(--bs-emphasis-color); /* Cor de texto padrão */
            font-size: 0.8rem;
            font-weight: 500;
            cursor: grab;
            transition: background-color 0.2s, border-color 0.2s, opacity 0.2s;
            user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;
        }
        .draggable-tag:hover {
            border-color: var(--bs-secondary);
            background-color: var(--bs-secondary-bg);
        }
        .dragging {
            opacity: 0.4;
            border-style: dashed;
        }
        /* Container dos algoritmos */
        #algorithms-source-container {
            padding: 1rem;
            border: 1px solid var(--bs-border-color);
            border-radius: 0.5rem; /* rounded-lg */
            background-color: var(--bs-body-bg); /* Fundo do body */
            margin-bottom: 2rem;
            min-height: 100px;
        }
        /* Zonas de Soltar */
        .drop-zone {
            min-height: 300px;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 2px dashed; /* Cor definida por ID abaixo */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background-color: var(--bs-tertiary-bg);
            transition: background-color 0.2s, border-color 0.2s;
            overflow-y: auto;
            max-height: 500px;
        }
        .drop-zone h3 {
            font-weight: 600;
            color: var(--bs-secondary-color);
            margin-bottom: 1rem;
            width: 100%;
            text-align: center;
            position: sticky;
            top: -1px; /* Ajuste para colar no topo dentro do scroll */
            background-color: var(--bs-tertiary-bg); /* Precisa de fundo para sticky */
            padding: 0.75rem 0;
            z-index: 10;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--bs-border-color);
        }
        /* Cores das bordas das zonas */
        #zone-supervised { border-color: var(--bs-purple); }
        #zone-unsupervised { border-color: var(--bs-teal); } /* Usando teal */
        #zone-reinforcement { border-color: var(--bs-warning); } /* Usando warning */
        #zone-deeplearning { border-color: var(--bs-pink); }

        .drop-zone .draggable-tag {
             margin-bottom: 0.5rem;
             width: 90%;
             font-size: 0.75rem;
             background-color: var(--bs-body-bg); /* Fundo branco/escuro */
             border-color: var(--bs-border-color-translucent);
             color: var(--bs-body-color); /* Cor de texto padrão do body */
        }
        .drag-over {
            border-style: solid;
            /* Usa a cor da borda da zona para o highlight (pode precisar de JS ou classes específicas) */
            /* Exemplo básico: */
             box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
             background-color: var(--bs-primary-bg-subtle); /* Fundo sutil primário */
             border-color: var(--bs-primary); /* Borda primária */
        }
        .item-incorrect {
             border: 2px solid var(--bs-danger) !important;
        }
        .feedback-item { margin-bottom: 0.25rem; }
        .counter { font-size: 0.75em; color: var(--bs-secondary-color); }
    </style>
{% endblock extra_head %}

{% block content %}
    {# Container principal do jogo (sem card externo) #}
    <div class="p-3">
        <h1 class="h4 fw-normal text-center text-body-emphasis mb-3">Jogo: Categorias de Algoritmos</h1>
        <p class="text-center text-body-secondary mb-4 small">Arraste cada algoritmo para a coluna da sua categoria correta.</p>

        <div id="algorithms-source-container">
            <h2 class="text-center text-body-secondary mb-3 small fw-medium">Algoritmos (arraste daqui):</h2>
            <div id="draggable-list" class="text-center">
                {# Itens arrastáveis (sem cores fixas, JS aplicará) #}
                <div id="item-arvore" draggable="true" class="draggable-tag" data-category="supervised">Árvores de Decisão</div>
                <div id="item-randomforest" draggable="true" class="draggable-tag" data-category="supervised">Random Forests</div>
                <div id="item-reglog" draggable="true" class="draggable-tag" data-category="supervised">Regressão Logística</div>
                <div id="item-reglinear" draggable="true" class="draggable-tag" data-category="supervised">Regressão Linear</div>
                <div id="item-knn" draggable="true" class="draggable-tag" data-category="supervised">KNN</div>
                <div id="item-svm" draggable="true" class="draggable-tag" data-category="supervised">SVM</div>
                <div id="item-naivebayes" draggable="true" class="draggable-tag" data-category="supervised">Naive Bayes</div>
                <div id="item-ann-sup" draggable="true" class="draggable-tag" data-category="supervised">Redes Neurais (Supervisionado)</div>
                <div id="item-anomalia" draggable="true" class="draggable-tag" data-category="unsupervised">Detecção de Anomalias</div>
                <div id="item-pca" draggable="true" class="draggable-tag" data-category="unsupervised">PCA</div>
                <div id="item-apriori" draggable="true" class="draggable-tag" data-category="unsupervised">Regras de Associação (Apriori)</div>
                <div id="item-em" draggable="true" class="draggable-tag" data-category="unsupervised">Expectation-Maximization (EM)</div>
                <div id="item-hierarquico" draggable="true" class="draggable-tag" data-category="unsupervised">Agrupamento Hierárquico</div>
                <div id="item-gmm" draggable="true" class="draggable-tag" data-category="unsupervised">GMM</div>
                <div id="item-dbscan" draggable="true" class="draggable-tag" data-category="unsupervised">DBSCAN</div>
                <div id="item-kmeans" draggable="true" class="draggable-tag" data-category="unsupervised">K-means</div>
                <div id="item-tsne" draggable="true" class="draggable-tag" data-category="unsupervised">t-SNE</div>
                <div id="item-ppo" draggable="true" class="draggable-tag" data-category="reinforcement">PPO</div>
                <div id="item-sarsa" draggable="true" class="draggable-tag" data-category="reinforcement">SARSA</div>
                <div id="item-a2c" draggable="true" class="draggable-tag" data-category="reinforcement">A2C</div>
                <div id="item-policygradient" draggable="true" class="draggable-tag" data-category="reinforcement">Policy Gradients</div>
                <div id="item-actorcritic" draggable="true" class="draggable-tag" data-category="reinforcement">Actor-Critic Methods</div>
                <div id="item-qlearning" draggable="true" class="draggable-tag" data-category="reinforcement">Q-learning</div>
                <div id="item-ddpg" draggable="true" class="draggable-tag" data-category="reinforcement">DDPG</div>
                <div id="item-dqn" draggable="true" class="draggable-tag" data-category="reinforcement">DQN</div>
                <div id="item-cnns" draggable="true" class="draggable-tag" data-category="deeplearning">CNNs</div>
                <div id="item-lstms" draggable="true" class="draggable-tag" data-category="deeplearning">LSTMs</div>
                <div id="item-gans" draggable="true" class="draggable-tag" data-category="deeplearning">GANs</div>
                <div id="item-rnns" draggable="true" class="draggable-tag" data-category="deeplearning">RNNs</div>
                <div id="item-transformers" draggable="true" class="draggable-tag" data-category="deeplearning">Transformers</div>
            </div>
        </div>

        <div class="mt-4"> {# Adiciona margem acima das zonas #}
             <h2 class="text-center text-body-secondary mb-3 small fw-medium">Tipos de Aprendizado (solte os algoritmos aqui)</h2>
             <div class="row g-3"> {# Usa row e g-3 para espaçamento #}
                <div class="col-sm-6 col-lg-3"> {# Responsivo: 2 col em SM, 4 em LG #}
                    <div id="zone-supervised" class="drop-zone h-100" data-category="supervised">
                        <h3 data-total="8">Supervisionado <span class="counter">(0/8)</span></h3>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div id="zone-unsupervised" class="drop-zone h-100" data-category="unsupervised">
                         <h3 data-total="9">Não Supervisionado <span class="counter">(0/9)</span></h3>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div id="zone-reinforcement" class="drop-zone h-100" data-category="reinforcement">
                         <h3 data-total="8">Por Reforço <span class="counter">(0/8)</span></h3>
                    </div>
                </div>
                 <div class="col-sm-6 col-lg-3">
                    <div id="zone-deeplearning" class="drop-zone h-100" data-category="deeplearning">
                         <h3 data-total="5">Profundo (Deep Learning) <span class="counter">(0/5)</span></h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 text-center"> {# Margem menor #}
            <button id="check-button" class="btn btn-primary btn-sm me-2">Verificar</button>
            <button id="reset-button" class="btn btn-secondary btn-sm">Reiniciar</button>
            <div id="feedback-message" class="mt-3 small fw-medium"></div>
            <div id="error-details" class="mt-1 text-danger small"></div> {# Texto de erro pequeno #}
        </div>
    </div> {# Fim do container principal p-3 #}

{% endblock content %}


{% block extra_js %}
    <script>
        // Seleciona elementos
        const draggables = document.querySelectorAll('.draggable-tag');
        const dropZones = document.querySelectorAll('.drop-zone');
        const algorithmsContainer = document.getElementById('algorithms-source-container').querySelector('#draggable-list');
        const checkButton = document.getElementById('check-button');
        const resetButton = document.getElementById('reset-button');
        const feedbackMessage = document.getElementById('feedback-message');
        const errorDetails = document.getElementById('error-details');

        let draggedItem = null;

        // --- Cores Aleatórias (Usando variáveis Bootstrap para tema claro/escuro) ---
        const colorCombinations = [
            // Pares: [classe-fundo-claro, classe-texto-claro, classe-borda-clara, classe-fundo-escuro, classe-texto-escuro, classe-borda-escura]
            // Ou mais simples: [classe-fundo-bootstrap, classe-texto-bootstrap, classe-borda-bootstrap]
            // Usando nomes de cores Bootstrap (ex: primary, secondary, success, etc.)
            ['bg-primary-subtle', 'text-primary-emphasis', 'border-primary-subtle'],
            ['bg-secondary-subtle', 'text-secondary-emphasis', 'border-secondary-subtle'],
            ['bg-success-subtle', 'text-success-emphasis', 'border-success-subtle'],
            ['bg-danger-subtle', 'text-danger-emphasis', 'border-danger-subtle'],
            ['bg-warning-subtle', 'text-warning-emphasis', 'border-warning-subtle'],
            ['bg-info-subtle', 'text-info-emphasis', 'border-info-subtle'],
            // ['bg-light-subtle', 'text-light-emphasis', 'border-light-subtle'], // Evitar light em fundo light
            ['bg-dark-subtle', 'text-dark-emphasis', 'border-dark-subtle'],
            // Cores nomeadas (podem precisar de ajuste de contraste dependendo do tema)
            ['bg-purple text-white border-purple', 'bg-purple', 'text-white', 'border-purple'], // Exemplo com cor nomeada (requer definição no CSS se não for do Bootstrap)
            ['bg-pink text-white border-pink', 'bg-pink', 'text-white', 'border-pink'], // Exemplo
        ];

        // Mapeamento simples de cores Bootstrap para classes (Adapte conforme necessário)
        const bsColorClasses = [
            'bg-primary-subtle text-primary-emphasis border-primary-subtle',
            'bg-secondary-subtle text-secondary-emphasis border-secondary-subtle',
            'bg-success-subtle text-success-emphasis border-success-subtle',
            'bg-danger-subtle text-danger-emphasis border-danger-subtle',
            'bg-warning-subtle text-warning-emphasis border-warning-subtle',
            'bg-info-subtle text-info-emphasis border-info-subtle',
            'bg-dark-subtle text-dark-emphasis border-dark-subtle', // Usando dark-subtle
            // Adicione mais variações se desejar
            'bg-primary text-white border-primary', // Cor sólida
            'bg-success text-white border-success',
            'bg-info text-dark border-info',
            'bg-warning text-dark border-warning',
            'bg-danger text-white border-danger',
            'bg-secondary text-white border-secondary',
            'bg-dark text-white border-dark',
        ];


        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function applyRandomColors() {
            const shuffledColors = [...bsColorClasses]; // Usa as classes Bootstrap
            shuffleArray(shuffledColors);
            // Remove classes de cor antigas (exceto draggable-tag)
             const colorPrefixes = ['bg-', 'text-', 'border-', 'alert-']; // Inclui alert- para limpar feedback anterior
             draggables.forEach(item => {
                 const currentClasses = item.className.split(' ');
                 const baseClasses = ['draggable-tag']; // Mantém apenas esta classe base
                 item.className = baseClasses.join(' ');
             });

            // Aplica novas cores
            draggables.forEach((item, index) => {
                const colorIndex = index % shuffledColors.length;
                item.classList.add(...shuffledColors[colorIndex].split(' '));
            });
        }

        document.addEventListener('DOMContentLoaded', applyRandomColors);

        // --- Lógica de Arrastar (Drag) ---
        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', (e) => {
                draggedItem = e.target;
                setTimeout(() => { e.target.classList.add('dragging'); }, 0);
                e.dataTransfer.setData('text/plain', e.target.id);
                e.dataTransfer.effectAllowed = 'move';
            });
            draggable.addEventListener('dragend', (e) => {
                if (e.target && e.target.classList) {
                    e.target.classList.remove('dragging');
                }
                draggedItem = null;
                updateCounters(); // Atualiza contadores após soltar
            });
        });

        // --- Lógica de Soltar (Drop) ---
        dropZones.forEach(zone => {
            zone.addEventListener('dragenter', (e) => { e.preventDefault(); const targetZone = e.target.closest('.drop-zone'); if (targetZone) targetZone.classList.add('drag-over'); });
            zone.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
            zone.addEventListener('dragleave', (e) => { const targetZone = e.target.closest('.drop-zone'); if (targetZone && !targetZone.contains(e.relatedTarget)) { targetZone.classList.remove('drag-over'); } });
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                const targetZone = e.target.closest('.drop-zone');
                if (!targetZone) return;
                targetZone.classList.remove('drag-over');
                if (draggedItem) {
                    if (!targetZone.contains(draggedItem)) {
                        targetZone.appendChild(draggedItem);
                        draggedItem.classList.remove('item-incorrect');
                    }
                }
                // dragend vai chamar updateCounters
            });
        });
         // Permite arrastar de volta para a lista original
         algorithmsContainer.parentElement.addEventListener('dragenter', (e) => { e.preventDefault(); e.target.closest('#algorithms-source-container').classList.add('drag-over'); });
         algorithmsContainer.parentElement.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
         algorithmsContainer.parentElement.addEventListener('dragleave', (e) => { const targetCont = e.target.closest('#algorithms-source-container'); if (targetCont && !targetCont.contains(e.relatedTarget)) { targetCont.classList.remove('drag-over'); }});
         algorithmsContainer.parentElement.addEventListener('drop', (e) => {
             e.preventDefault();
             const targetCont = e.target.closest('#algorithms-source-container');
             if (!targetCont) return;
             targetCont.classList.remove('drag-over');
             if (draggedItem) {
                 algorithmsContainer.appendChild(draggedItem);
                 draggedItem.classList.remove('item-incorrect');
             }
             // dragend vai chamar updateCounters
         });


        // --- Lógica de Verificação ---
        checkButton.addEventListener('click', () => {
            let correctCount = 0;
            let totalPlaced = 0;
            const errors = [];
            draggables.forEach(item => item.classList.remove('item-incorrect'));
            errorDetails.innerHTML = '';

            dropZones.forEach(zone => {
                const zoneCategory = zone.dataset.category;
                const droppedItems = zone.querySelectorAll('.draggable-tag');
                droppedItems.forEach(item => {
                    totalPlaced++;
                    const itemConcept = item.dataset.category; // Usa data-category agora
                    if (itemConcept === zoneCategory) {
                        correctCount++;
                    } else {
                        item.classList.add('item-incorrect');
                        errors.push(`'${item.textContent}' está na categoria errada.`);
                    }
                });
            });

            const totalItems = draggables.length;
            const itemsStillInContainer = algorithmsContainer.querySelectorAll('.draggable-tag').length;
            feedbackMessage.className = 'mt-3 small fw-medium'; // Reset e aplica estilo menor

            if (itemsStillInContainer > 0) {
                 feedbackMessage.textContent = `Por favor, arraste todos os ${totalItems} algoritmos.`;
                 feedbackMessage.classList.add('text-warning');
            } else if (correctCount === totalItems) {
                feedbackMessage.textContent = 'Parabéns! Tudo correto!';
                feedbackMessage.classList.add('text-success');
            } else {
                feedbackMessage.textContent = `Correto: ${correctCount}/${totalItems}. Verifique os itens em vermelho.`;
                feedbackMessage.classList.add('text-danger');
                if (errors.length > 0) {
                    errorDetails.innerHTML = errors.map(err => `<p class="feedback-item">${err}</p>`).join('');
                }
            }
        });

        // --- Lógica de Reiniciar ---
        resetButton.addEventListener('click', () => {
            draggables.forEach(draggable => {
                algorithmsContainer.appendChild(draggable);
                draggable.classList.remove('item-incorrect');
            });
            feedbackMessage.textContent = '';
            feedbackMessage.className = 'mt-3 small fw-medium'; // Reset
            errorDetails.innerHTML = '';
            updateCounters(); // Reseta contadores
            applyRandomColors(); // Reaplica cores aleatórias
        });

        // Inicializa contadores no carregamento
        document.addEventListener('DOMContentLoaded', updateCounters);

    </script>
{% endblock extra_js %}