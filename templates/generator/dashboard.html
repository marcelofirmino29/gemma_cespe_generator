{% extends 'generator/base.html' %}
{% load static %}

{% block title %}Meu Desempenho - Gerador IA{% endblock title %}

{% block extra_head %}
    {# Link para CSS externo (se houver) #}
    <link rel="stylesheet" href="{% static 'generator/css/dashboard_styles.css' %}">
    <style>
        /* Estilos base */
        .nav-tabs .nav-link {
            border-top-left-radius: 0.375rem;
            border-top-right-radius: 0.375rem;
            border-bottom: none;
            color: var(--bs-secondary-color);
            background-color: var(--bs-tertiary-bg);
            border-color: var(--bs-border-color);
            padding: 0.5rem 1rem;
        }
        .nav-tabs .nav-link.active {
            color: var(--bs-primary);
            background-color: var(--bs-body-bg); /* Fundo do corpo para aba ativa */
            border-color: var(--bs-border-color);
            border-bottom-color: var(--bs-body-bg); /* Esconde a borda inferior */
            font-weight: 600;
        }
        .filters-container {
            border: 1px solid var(--bs-border-color);
            border-top: none; /* Remove borda superior pois as abas já têm */
            padding: 1.5rem;
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            background-color: var(--bs-body-bg); /* Fundo do corpo */
        }
        .form-label { font-size: 0.85rem; margin-bottom: 0.3rem; /* Menor margem */ }
        .form-control, .form-select { font-size: 0.9rem; /* Tamanho de fonte padrão para inputs */ }
        .form-control-sm, .form-select-sm { font-size: 0.85rem; } /* Mantém sm se usado */
        .form-text { font-size: 0.75rem; /* Texto de ajuda menor */ }
        .btn-filter-action { font-size: 0.9rem; }

        /* Estilo para o texto da questão renderizado (substitui o <pre>) */
        .generated-exam-markdown {
            white-space: pre-wrap; /* Mantém quebras de linha e espaços */
            word-wrap: break-word;
            background-color: var(--bs-tertiary-bg);
            padding: 1rem;
            border-radius: 0.375rem;
            border: 1px solid var(--bs-border-color);
            font-size: 0.9em; /* Texto um pouco menor */
            line-height: 1.6; /* Melhora legibilidade */
        }
        .generated-exam-markdown p { margin-bottom: 0.5rem; } /* Espaçamento entre parágrafos se houver */
        .generated-exam-markdown strong { font-weight: 600; } /* Garante negrito */
        .generated-exam-markdown ol,
        .generated-exam-markdown ul { padding-left: 2rem; margin-bottom: 0.5rem;} /* Indentação de listas */


        /* Garante que labels fiquem acima dos campos */
        label { display: block; margin-bottom: 0.25rem; }

         /* Ajuste para textarea (tópico) */
        #{{ form.base_topic_or_context.id_for_label }} {
            min-height: 80px; /* Altura mínima para o campo tópico */
        }

    </style>
{% endblock extra_head %}


{% block content %} {# Conteúdo específico da página #}

    {# Mensagens #}
    {% if messages %}{% for message in messages %}<div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} alert-dismissible fade show" role="alert"> {{ message }} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>{% endfor %}{% endif %}
    {% if error_message %} <div class="alert alert-danger">{{ error_message }}</div> {% endif %}

    {# --- Abas de Navegação --- #}
    <ul class="nav nav-tabs mb-0" id="mainTabs" role="tablist">
       <li class="nav-item" role="presentation">
         {# Link para Gerador C/E #}
         <a class="nav-link" href="{% url 'generator:generate_questions' %}">Gerador C/E</a>
       </li>
       <li class="nav-item" role="presentation">
         {# Link para Gerador Discursiva #}
         <a class="nav-link" href="{% url 'generator:generate_discursive_exam' %}">Gerador Discursiva</a>
       </li>
       <li class="nav-item" role="presentation">
         {# Link para Configurar Simulado #}
         <a class="nav-link" href="{% url 'generator:configurar_simulado' %}">Configurar Simulado</a>
       </li>
       <li class="nav-item" role="presentation">
         {# Link/Aba Ativa para Dashboard #}
         <a class="nav-link active" href="{% url 'generator:dashboard' %}" id="dashboard-tab" role="tab" aria-selected="true">Meu Desempenho</a>
       </li>
       {# Adicione outras abas principais se desejar #}
    </ul>
    {# --- Fim Abas de Navegação --- #}

    {# Container Principal #}
    <div class="tab-content" id="mainTabContent">
      <div class="tab-pane fade show active" id="dashboard-panel" role="tabpanel" aria-labelledby="dashboard-tab">
        <div class="content-container shadow-sm"> {# Usa a classe content-container #}

            {# --- Formulário de Filtro por Data e Área --- #}
            <div class="filter-form mb-4">
                <form method="get" action="{% url 'generator:dashboard' %}" class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="date_from" class="form-label fw-bold small mb-1">Filtrar Período De:</label>
                        <input type="date" class="form-control form-control-sm" id="date_from" name="date_from" value="{{ current_date_from|date:'Y-m-d'|default:'' }}">
                    </div>
                    <div class="col-md-3">
                        <label for="date_to" class="form-label fw-bold small mb-1">Até:</label>
                        <input type="date" class="form-control form-control-sm" id="date_to" name="date_to" value="{{ current_date_to|date:'Y-m-d'|default:'' }}">
                    </div>
                     <div class="col-md-3">
                        <label for="area_filter" class="form-label fw-bold small mb-1">Área:</label>
                        <select class="form-select form-select-sm" id="area_filter" name="area_filter">
                            <option value="">Todas as Áreas</option>
                            {% for area in all_areas %}
                                <option value="{{ area.id }}" {% if current_area_filter and current_area_filter.id == area.id %}selected{% endif %}>{{ area.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-auto">
                        <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
                        <a href="{% url 'generator:dashboard' %}" class="btn btn-outline-secondary btn-sm ms-2" title="Remover Filtro">Limpar</a>
                    </div>
                </form>
            </div>
            {# --- FIM: Formulário de Filtro --- #}


            {# --- Seção de Estatísticas e Gráfico (SEM CARDS) --- #}
            <div class="row mb-4 g-4">

                {# --- Bloco de Estatísticas (Resumo C/E) --- #}
                <div class="col-lg-7">
                    <h2 class="h5 mb-3 fw-normal">Resumo C/E {% if current_date_from or current_date_to or current_area_filter %}(Período/Área Filtrado){% else %}(Geral){% endif %}</h2>
                    <div class="p-3 rounded border bg-body-secondary"> {# Div com fundo e borda #}
                        {% if stats %}
                        <div class="row text-center g-3 w-100">
                            {# Colunas com stats e ícones como antes #}
                            <div class="col-md-3 col-6"> <i class="bi bi-collection text-secondary stat-icon"></i> <div class="stat-value">{{ stats.total_ce|default_if_none:"0" }}</div> <div class="stat-label text-muted">Tentativas C/E</div> </div>
                            <div class="col-md-3 col-6"> <i class="bi bi-check-circle-fill text-success stat-icon"></i> <div class="stat-value text-success">{{ stats.acertos_ce|default_if_none:"0" }}</div> <div class="stat-label text-muted">Acertos</div> </div>
                            <div class="col-md-3 col-6"> <i class="bi bi-x-octagon-fill text-danger stat-icon"></i> <div class="stat-value text-danger">{{ stats.erros_ce|default_if_none:"0" }}</div> <div class="stat-label text-muted">Erros</div> </div>
                            <div class="col-md-3 col-6"> <i class="bi bi-calculator-fill stat-icon {% if stats.score_ce > 0 %}text-success{% elif stats.score_ce < 0 %}text-danger{% else %}text-secondary{% endif %}"></i> <div class="stat-value {% if stats.score_ce > 0 %}text-success{% elif stats.score_ce < 0 %}text-danger{% else %}text-muted{% endif %}"> {% if stats.score_ce > 0 %}+{% endif %}{{ stats.score_ce|default_if_none:"0" }} </div> <div class="stat-label text-muted">Score Líquido</div> </div>
                            {% if stats.total_ce > 0 %}
                            <div class="col-12 mt-3">
                                 <div class="progress" role="progressbar" aria-label="Percentual de acerto" aria-valuenow="{{ stats.percentual_ce }}" aria-valuemin="0" aria-valuemax="100" style="height: 6px;"> <div class="progress-bar bg-success" style="width: {{ stats.percentual_ce }}%"></div> </div>
                                 <small class="text-muted">Aproveitamento Bruto: {{ stats.percentual_ce|default_if_none:"0" }}%</small>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                            <div class="alert alert-secondary small w-100 text-center mb-0">Sem dados para o período/área selecionado(a).</div> {# Removido mb padrão do alert #}
                        {% endif %}
                    </div>
                </div>

                {# --- Bloco do Gráfico --- #}
                <div class="col-lg-5">
                    <h2 class="h5 mb-3 fw-normal">Distribuição Acertos/Erros (C/E - Seleção)</h2>
                     <div class="p-3 rounded border bg-body-secondary d-flex align-items-center justify-content-center" style="min-height: 300px;"> {# Div com fundo e borda, altura mínima #}
                         {% if stats and stats.total_ce > 0 %}
                             <div class="chart-container">
                                 <canvas id="acertosErrosChart" data-acertos="{{ stats.acertos_ce|default_if_none:0 }}" data-erros="{{ stats.erros_ce|default_if_none:0 }}">Gráfico indisponível.</canvas>
                             </div>
                         {% elif stats %}
                             <div class="text-center text-muted small w-100">Responda questões C/E para gerar o gráfico.</div>
                         {% else %}
                             <div class="text-center text-muted small w-100">Gráfico indisponível.</div>
                         {% endif %}
                     </div>
                </div>
            </div> {# --- Fim da row de Stats/Gráfico --- #}


            {# --- Seção do Histórico Recente (Tabela - SEM CARD) --- #}
            <div class="mb-4"> {# Apenas margem inferior #}
                <h2 class="h5 mb-3 fw-normal">Histórico de Tentativas {% if current_date_from or current_date_to or current_area_filter %}(Período/Área Filtrado){% else %}(Últimas 20){% endif %}</h2>
                {% if tentativas_list %}
                    <div class="table-responsive border rounded"> {# Adiciona borda e responsividade #}
                        <table class="table table-striped table-hover mb-0 small"> {# Tabela pequena #}
                            <thead>
                                <tr>
                                    <th scope="col">Data</th>
                                    <th scope="col">Tipo</th>
                                    <th scope="col">Área</th>
                                    <th scope="col">Questão (Início)</th>
                                    <th scope="col" class="text-center">Sua Resposta</th> {# Centralizado #}
                                </tr>
                            </thead>
                            <tbody>
                                {% for tentativa in tentativas_list %}
                                <tr>
                                    <td class="text-nowrap">{{ tentativa.data_resposta|date:"d/m/Y H:i" }}</td>
                                    <td><span class="badge {% if tentativa.questao.tipo == 'CE' %}bg-primary-subtle text-primary-emphasis{% else %}bg-info-subtle text-info-emphasis{% endif %}">{{ tentativa.questao.get_tipo_display }}</span></td>
                                    <td>{{ tentativa.questao.area.nome|default:"-" }}</td>
                                    <td>{{ tentativa.questao.texto_comando|truncatewords:12 }}</td>
                                    <td class="text-center">
                                        {% if tentativa.resposta_ce %}
                                            <span class="fw-bold">{{ tentativa.resposta_ce }}</span>
                                            {% with avaliacao=tentativa.avaliacao %} {# Usar with para evitar erro #}
                                                {% if avaliacao and avaliacao.correto_ce is not None %}
                                                    {% if avaliacao.correto_ce %}<i class="bi bi-check-circle-fill text-success ms-1" title="Correto"></i>
                                                    {% else %}<i class="bi bi-x-circle-fill text-danger ms-1" title="Errado"></i>
                                                    {% endif %}
                                                {% endif %}
                                            {% endwith %}
                                        {% elif tentativa.resposta_discursiva %}
                                            <span class="text-muted fst-italic">Discursiva</span>
                                        {% else %} <span class="text-muted">N/R</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-secondary mt-3 small"> {# Alert em vez de p #}
                        Nenhuma tentativa encontrada{% if current_date_from or current_date_to or current_area_filter %} para a seleção atual{% endif %}.
                    </div>
                {% endif %}
            </div>
            {# --- FIM: Histórico --- #}

        </div> {# Fim content-container #}
      </div> {# Fim tab-pane #}
    </div> {# Fim tab-content #}

     {# Mensagem de rodapé como na imagem de filtros #}
    <div class="alert alert-secondary mt-4 small text-center">
        Visualize seu desempenho geral ou filtre por período/área.
    </div>

{% endblock content %}


{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="{% static 'generator/js/dashboard_charts.js' %}" defer></script>
{% endblock extra_js %}
