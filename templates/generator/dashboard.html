{% extends 'generator/base.html' %}
{% load static %}

{% block title %}Meu Desempenho - Gerador IA{% endblock title %}

{% block extra_head %}
    {# Adicione estilos específicos para o card de stats se desejar #}
    <style>
        .stat-value { font-size: 1.75rem; font-weight: bold; }
        .stat-label { font-size: 0.9rem; }
    </style>
{% endblock extra_head %}


{% block content %}
    <header class="text-center mb-4">
        <h1>Meu Desempenho</h1>
        <p class="lead">Acompanhe seu histórico e estatísticas.</p>
        {% if local_time %}<p><small>(Horário Local {{ local_time }})</small></p>{% endif %}
    </header>

    {% if error_message %}
        <div class="alert alert-danger">{{ error_message }}</div>
    {% endif %}

    {# --- INÍCIO: Seção de Estatísticas Adicionada --- #}
    {% if stats %} {# Verifica se o dicionário de stats existe no contexto #}
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h2 class="h5 mb-0">Resumo Certo/Errado (Geral)</h2>
        </div>
        <div class="card-body">
            <div class="row text-center g-3"> {# g-3 para espaçamento entre colunas #}
                <div class="col-md-3 col-6"> {# Ocupa 3 de 12 colunas em telas médias ou maiores, 6 de 12 em pequenas #}
                    <div class="stat-value">{{ stats.total_ce|default_if_none:"0" }}</div>
                    <div class="stat-label text-muted">Tentativas C/E</div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-value text-success">{{ stats.acertos_ce|default_if_none:"0" }}</div>
                    <div class="stat-label text-muted">Acertos</div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-value text-danger">{{ stats.erros_ce|default_if_none:"0" }}</div>
                    <div class="stat-label text-muted">Erros</div>
                </div>
                <div class="col-md-3 col-6">
                     {# Aplica cor baseada no score #}
                    <div class="stat-value {% if stats.score_ce > 0 %}text-success{% elif stats.score_ce < 0 %}text-danger{% else %}text-muted{% endif %}">
                        {% if stats.score_ce > 0 %}+{% endif %}{{ stats.score_ce|default_if_none:"0" }}
                    </div>
                    <div class="stat-label text-muted">Score Líquido</div>
                </div>
                {# Exibe percentual se houver tentativas #}
                {% if stats.total_ce > 0 %}
                <div class="col-12 mt-2">
                     <small class="text-muted">Aproveitamento bruto: {{ stats.percentual_ce|default_if_none:"0" }}%</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
        {# Mensagem se as stats não puderam ser calculadas pela view #}
        <div class="alert alert-secondary small">Estatísticas de desempenho ainda não disponíveis.</div>
    {% endif %}
    {# --- FIM: Seção de Estatísticas --- #}


    {# Seção do Histórico Recente (Tabela como antes) #}
    <div class="card shadow-sm">
        <div class="card-header">
            <h2 class="h5 mb-0">Últimas Tentativas (Máx. 20)</h2> {# Atualiza título da tabela #}
        </div>
        <div class="card-body p-0">
            {% if tentativas_list %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th scope="col">Data</th>
                                <th scope="col">Tipo</th>
                                <th scope="col">Área</th>
                                <th scope="col">Questão (Início)</th>
                                <th scope="col">Sua Resposta</th>
                                {# <th scope="col">Resultado</th> <! - - Adicionaremos depois --> #}
                            </tr>
                        </thead>
                        <tbody>
                            {% for tentativa in tentativas_list %}
                            <tr>
                                <td class="text-nowrap">{{ tentativa.data_resposta|date:"d/m/Y H:i" }}</td>
                                <td><span class="badge {% if tentativa.questao.tipo == 'CE' %}bg-primary{% else %}bg-info{% endif %}">{{ tentativa.questao.get_tipo_display }}</span></td>
                                <td>{{ tentativa.questao.area.nome|default:"-" }}</td>
                                <td>{{ tentativa.questao.texto_comando|truncatewords:12 }}</td>
                                <td class="small">
                                    {% if tentativa.resposta_ce %}
                                        <span class="fw-bold">{{ tentativa.resposta_ce }}</span>
                                    {% elif tentativa.resposta_discursiva %}
                                        {{ tentativa.resposta_discursiva|truncatewords_html:10 }}
                                    {% else %}
                                        <span class="text-muted">N/R</span>
                                    {% endif %}
                                </td>
                                {# ... (coluna resultado ainda comentada) ... #}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="p-3 text-center text-muted">
                    Você ainda não respondeu nenhuma questão. Comece a gerar e responder!
                </div>
            {% endif %}
        </div>
    </div>

{% endblock content %}