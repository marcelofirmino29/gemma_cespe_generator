{% extends 'generator/base.html' %}
{% load static %}

{% block title %}Meu Desempenho - Gerador IA{% endblock title %}

{% block extra_head %}
    {# Link para CSS externo (se houver) #}
    <link rel="stylesheet" href="{% static 'generator/css/dashboard_styles.css' %}">
    <style>
        /* Estilos mínimos inline (ou mova para dashboard_styles.css) */
        .stat-value { font-size: 1.75rem; font-weight: bold; }
        .stat-label { font-size: 0.9rem; }
        .chart-container { position: relative; margin: auto; height: 250px; width: 100%; max-width: 300px; }
        .stat-icon { font-size: 2.5rem; margin-bottom: 0.5rem; display: block; }
        .filter-form { padding: 1rem 1.5rem; background-color: var(--bs-tertiary-bg); border-radius: 0.5rem; border: 1px solid var(--bs-border-color); }
        [data-bs-theme="dark"] .filter-form { box-shadow: 0 0.125rem 0.25rem rgba(255, 255, 255, 0.075); }
        /* Remove margem inferior padrão da tabela dentro do card-body p-0 (se usado) */
        /* .card-body.p-0 .table { margin-bottom: 0 !important; } */
    </style>
{% endblock extra_head %}


{% block content %} {# Conteúdo específico da página #}

    {# Removido Header principal #}
    {# {% if local_time %}...{% endif %} #}

    {# Mensagens #}
    {% if messages %}{% for message in messages %}<div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} alert-dismissible fade show" role="alert"> {{ message }} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>{% endfor %}{% endif %}
    {% if error_message %} <div class="alert alert-danger">{{ error_message }}</div> {% endif %}

    {# --- Formulário de Filtro por Data (Mantido com estilo) --- #}
    <div class="filter-form mb-4"> {# Adicionado mb-4 #}
        <form method="get" action="{% url 'generator:dashboard' %}" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="date_from" class="form-label fw-bold small mb-1">Filtrar Período:</label>
                <input type="date" class="form-control form-control-sm" id="date_from" name="date_from" value="{{ current_date_from|date:'Y-m-d'|default:'' }}">
            </div>
            <div class="col-md-4">
                <label for="date_to" class="form-label visually-hidden">Até:</label>
                <input type="date" class="form-control form-control-sm" id="date_to" name="date_to" value="{{ current_date_to|date:'Y-m-d'|default:'' }}">
            </div>
            <div class="col-md-auto">
                <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
                <a href="{% url 'generator:dashboard' %}" class="btn btn-outline-secondary btn-sm ms-2" title="Remover Filtro">Limpar</a>
            </div>
        </form>
    </div>
    {# --- FIM: Formulário de Filtro --- #}


    {# --- Seção de Estatísticas e Gráfico (SEM CARDS) --- #}
    <div class="row mb-4 g-4">

        {# --- Bloco de Estatísticas (Resumo C/E) --- #}
        <div class="col-lg-7">
            <h2 class="h5 mb-3 fw-normal">Resumo C/E {% if current_date_from %}(Período Filtrado){% else %}(Geral){% endif %}</h2> {# Título simplificado #}
            <div class="p-3 rounded border bg-body-secondary"> {# Div com fundo e borda #}
                {% if stats %}
                <div class="row text-center g-3 w-100">
                    {# Colunas com stats e ícones como antes #}
                    <div class="col-md-3 col-6"> <i class="bi bi-collection text-secondary stat-icon"></i> <div class="stat-value">{{ stats.total_ce|default_if_none:"0" }}</div> <div class="stat-label text-muted">Tentativas C/E</div> </div>
                    <div class="col-md-3 col-6"> <i class="bi bi-check-circle-fill text-success stat-icon"></i> <div class="stat-value text-success">{{ stats.acertos_ce|default_if_none:"0" }}</div> <div class="stat-label text-muted">Acertos</div> </div>
                    <div class="col-md-3 col-6"> <i class="bi bi-x-octagon-fill text-danger stat-icon"></i> <div class="stat-value text-danger">{{ stats.erros_ce|default_if_none:"0" }}</div> <div class="stat-label text-muted">Erros</div> </div>
                    <div class="col-md-3 col-6"> <i class="bi bi-calculator-fill stat-icon {% if stats.score_ce > 0 %}text-success{% elif stats.score_ce < 0 %}text-danger{% else %}text-secondary{% endif %}"></i> <div class="stat-value {% if stats.score_ce > 0 %}text-success{% elif stats.score_ce < 0 %}text-danger{% else %}text-muted{% endif %}"> {% if stats.score_ce > 0 %}+{% endif %}{{ stats.score_ce|default_if_none:"0" }} </div> <div class="stat-label text-muted">Score Líquido</div> </div>
                    {% if stats.total_ce > 0 %}
                    <div class="col-12 mt-3">
                         <div class="progress" role="progressbar" aria-label="Percentual de acerto" aria-valuenow="{{ stats.percentual_ce }}" aria-valuemin="0" aria-valuemax="100" style="height: 6px;"> <div class="progress-bar bg-success" style="width: {{ stats.percentual_ce }}%"></div> </div>
                         <small class="text-muted">Aproveitamento Bruto: {{ stats.percentual_ce|default_if_none:"0" }}%</small>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                    <div class="alert alert-secondary small w-100 text-center mb-0">Sem dados para o período.</div> {# Removido mb padrão do alert #}
                {% endif %}
            </div>
        </div>

        {# --- Bloco do Gráfico --- #}
        <div class="col-lg-5">
            <h2 class="h5 mb-3 fw-normal">Distribuição Acertos/Erros (C/E - Período)</h2> {# Título simplificado #}
             <div class="p-3 rounded border bg-body-secondary d-flex align-items-center justify-content-center" style="min-height: 300px;"> {# Div com fundo e borda, altura mínima #}
                 {% if stats and stats.total_ce > 0 %}
                     <div class="chart-container">
                         <canvas id="acertosErrosChart" data-acertos="{{ stats.acertos_ce|default_if_none:0 }}" data-erros="{{ stats.erros_ce|default_if_none:0 }}">Gráfico indisponível.</canvas>
                     </div>
                 {% elif stats %}
                     <div class="text-center text-muted small w-100">Responda questões C/E para gerar o gráfico.</div>
                 {% else %}
                     <div class="text-center text-muted small w-100">Gráfico indisponível.</div>
                 {% endif %}
             </div>
        </div>
    </div> {# --- Fim da row de Stats/Gráfico --- #}


    {# --- Seção do Histórico Recente (Tabela - SEM CARD) --- #}
    <div class="mb-4"> {# Apenas margem inferior #}
        <h2 class="h5 mb-3 fw-normal">Histórico de Tentativas {% if current_date_from %}(Período Filtrado){% else %}(Últimas 20){% endif %}</h2>
        {% if tentativas_list %}
            <div class="table-responsive border rounded"> {# Adiciona borda e responsividade #}
                <table class="table table-striped table-hover mb-0 small"> {# Tabela pequena #}
                    <thead>
                        <tr>
                            <th scope="col">Data</th>
                            <th scope="col">Tipo</th>
                            <th scope="col">Área</th>
                            <th scope="col">Questão (Início)</th>
                            <th scope="col" class="text-center">Sua Resposta</th> {# Centralizado #}
                        </tr>
                    </thead>
                    <tbody>
                        {% for tentativa in tentativas_list %}
                        <tr>
                            <td class="text-nowrap">{{ tentativa.data_resposta|date:"d/m/Y H:i" }}</td>
                            <td><span class="badge {% if tentativa.questao.tipo == 'CE' %}bg-primary-subtle text-primary-emphasis{% else %}bg-info-subtle text-info-emphasis{% endif %}">{{ tentativa.questao.get_tipo_display }}</span></td>
                            <td>{{ tentativa.questao.area.nome|default:"-" }}</td>
                            <td>{{ tentativa.questao.texto_comando|truncatewords:12 }}</td>
                            <td class="text-center">
                                {% if tentativa.resposta_ce %}
                                    <span class="fw-bold">{{ tentativa.resposta_ce }}</span>
                                    {% with avaliacao=tentativa.avaliacao %} {# Usar with para evitar erro #}
                                        {% if avaliacao and avaliacao.correto_ce is not None %}
                                            {% if avaliacao.correto_ce %}<i class="bi bi-check-circle-fill text-success ms-1" title="Correto"></i>
                                            {% else %}<i class="bi bi-x-circle-fill text-danger ms-1" title="Errado"></i>
                                            {% endif %}
                                        {% endif %}
                                    {% endwith %}
                                {% elif tentativa.resposta_discursiva %}
                                    <span class="text-muted fst-italic">Discursiva</span>
                                {% else %} <span class="text-muted">N/R</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-secondary mt-3 small"> {# Alert em vez de p #}
                Nenhuma tentativa encontrada{% if current_date_from or current_date_to %} neste período{% endif %}.
            </div>
        {% endif %}
    </div>
    {# --- FIM: Histórico --- #}

{% endblock content %}


{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="{% static 'generator/js/dashboard_charts.js' %}" defer></script>
{% endblock extra_js %}